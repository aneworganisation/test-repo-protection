name: Setup Branch Protection & Naming (REST + PAT)

on:
  workflow_dispatch:

jobs:
  protect:
    runs-on: ubuntu-latest
    env:
      OWNER: ${{ github.repository_owner }}
      REPO: ${{ github.event.repository.name }}
      ADMIN_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}
    steps:
      - name: Preflight — verify PAT & repo access
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          set -e
          test -n "$GH_TOKEN" || { echo "❌ Missing REPO_ADMIN_TOKEN secret"; exit 1; }
          gh api /user >/dev/null || { echo "❌ PAT invalid/expired"; exit 1; }
          gh api "/repos/$OWNER/$REPO" >/dev/null || {
            echo "❌ PAT cannot access $OWNER/$REPO. Ensure PAT resource owner = your org, repo selected, SSO authorized."; exit 1; }
          echo "✅ PAT valid and can see $OWNER/$REPO"

      - name: Detect default branch (not assumed to be 'main')
        id: def
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          set -e
          DEF=$(gh api "/repos/$OWNER/$REPO" --jq .default_branch)
          echo "default_branch=$DEF" >> "$GITHUB_OUTPUT"
          echo "ℹ️ Default branch is: $DEF"

      - name: Protect default branch (PRs, approvals, CODEOWNERS, strict checks)
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          set -e
          DEF="${{ steps.def.outputs.default_branch }}"
          cat > body.json <<'JSON'
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ["build","unit-tests","lint","sast","coverage"]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "dismiss_stale_reviews": true,
              "require_code_owner_reviews": true,
              "required_approving_review_count": 2
            },
            "restrictions": null,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "required_linear_history": false,
            "block_creations": false,
            "required_conversation_resolution": true,
            "lock_branch": false,
            "allow_fork_syncing": false
          }
          JSON
          gh api \
            --method PUT \
            -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/branches/$DEF/protection" \
            --input body.json

      - name: Enable required signed commits on default branch (best-effort)
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          DEF="${{ steps.def.outputs.default_branch }}"
          gh api -X POST -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/branches/$DEF/protection/required_signatures" \
            || echo "ℹ️ Signed-commit enforcement may be blocked by plan/policy; continuing."

      - name: Protect all existing release/* branches (loop via REST)
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          set -e
          # List all branches and filter release/*
          mapfile -t RELS < <(gh api "/repos/$OWNER/$REPO/branches?per_page=100" --jq '.[].name | select(test("^release/"))')
          if [ ${#RELS[@]} -eq 0 ]; then
            echo "ℹ️ No release/* branches exist yet. You can create them and re-run this workflow."
            exit 0
          fi

          for BR in "${RELS[@]}"; do
            echo "🔒 Protecting $BR ..."
            cat > body.json <<'JSON'
            {
              "required_status_checks": {
                "strict": true,
                "contexts": ["build","unit-tests","lint","sast","coverage"]
              },
              "enforce_admins": true,
              "required_pull_request_reviews": {
                "dismiss_stale_reviews": true,
                "require_code_owner_reviews": true,
                "required_approving_review_count": 1
              },
              "restrictions": null,
              "allow_force_pushes": false,
              "allow_deletions": false,
              "required_linear_history": false,
              "block_creations": false,
              "required_conversation_resolution": true,
              "lock_branch": false,
              "allow_fork_syncing": false
            }
            JSON
            gh api \
              --method PUT \
              -H "Accept: application/vnd.github+json" \
              "/repos/$OWNER/$REPO/branches/$BR/protection" \
              --input body.json
          done

      - name: Protect tags v* (prevent moving release tags)
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          gh api -X POST -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/tags/protection" \
            -f pattern='v*' || true

      - name: Check out (use PAT to push)
        uses: actions/checkout@v4
        with:
          token: ${{ env.ADMIN_TOKEN }}

      - name: Add branch-name enforcement workflow
        run: |
          mkdir -p .github/workflows
          cat > .github/workflows/branch-name-check.yml <<'WF'
          name: Branch name check
          on:
            create:
            push:
              branches-ignore:
                - main
                - 'release/*'
          jobs:
            enforce:
              runs-on: ubuntu-latest
              steps:
                - name: Validate branch name
                  run: |
                    BRANCH="${GITHUB_REF_NAME}"
                    # Allowed: feat/, fix/, hotfix/, chore/, refactor/, docs/, test/, perf/, build/, ci/, revert/
                    PATTERN='^(feat|fix|hotfix|chore|refactor|docs|test|perf|build|ci|revert)\/[a-z0-9._-]+$'
                    if [[ "$BRANCH" =~ ^(main|release\/.+)$ ]]; then
                      echo "Skipping enforcement for $BRANCH"; exit 0; fi
                    if [[ "$BRANCH" =~ $PATTERN ]]; then
                      echo "Branch name OK: $BRANCH"
                    else
                      echo "❌ Branch name '$BRANCH' does not match: $PATTERN
                      Examples:
                        feat/add-login
                        fix/null-pointer
                        hotfix/rollback-v123
                        docs/readme-update" >&2
                      exit 1
                    fi
          WF
          git add .github/workflows/branch-name-check.yml
          git -c user.name="github-actions" -c user.email="actions@users.noreply.github.com" \
            commit -m "chore: add branch name enforcement workflow" || echo "No changes"
          git push origin HEAD:${{ steps.def.outputs.default_branch }}
